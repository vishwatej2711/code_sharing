def processBuildLib(stage_name, PIPELINE_PRIORITY)
{
    jenkinsOps.printAgentWSInfo()
    script
    {
        try
        {
            // error("kumbhvsh:introduced error in Build libs")
            jenkinsOps.prepws()
            dir("amg-hpedu")
            {
                git.checkout_prj(PIPELINE_PRIORITY)
                softwareIdInfo()
            }
            dir("amg-hpedu/200_SwLib/RDNA/Lib")
            {
                artifactory.checkout_prj()
            }
            timeout (time: 20, unit: 'MINUTES')
            {
                getRDNALib_Version_Artifactory()
                getLib_Version_GitSubmodule()
                dir("amg-hpedu/800_Workspace/IBC_Appl_Tasking/make")
                {
                    bpinstaller()
                    bat 'sh -o pipefail -c "python gen_mcal.py --TB"'
                    bat 'sh -o pipefail -c "python gen.py --TB"'
                    bat 'sh -o pipefail -c "ninja -j 4 2>&1 | tee make_warn.log"'
                }
                dir("amg-hpedu/800_Workspace/IBC_Appl_Tasking/OnTargetTests/make")
                {
                    bpinstaller()
                    bat 'sh -o pipefail -c "./build.cmd --TB ${TOOLPATH} 2>&1 | tee make_warn_OTT.log"'
                    bat 'sh -o pipefail -c "ninja -j 4 2>&1 | tee make_warn.log"'
                }
                getTasking_Version()
                getPython_Version()
                getNinja_Version()
                getGit_Version()
                getBpInstaller_Version()
            }
        }
        catch(Exception e)
        {
            echo "Stage ${stage_name} failed with error from processBuildLib: ${e}"
            currentBuild.result = 'FAILURE'
            error("Build libs failed from processBuildLib: ${e}")
            // abort_jenkins_build()
        }
    }
}
def processA2Lgeneration(stage_name, PIPELINE_PRIORITY)
{
    jenkinsOps.printAgentWSInfo()
    script
    {
        try
        {
            // error("kumbhvsh:introduced error in Generate a2l funciton")
            jenkinsOps.prepws()
            dir("amg-hpedu")
            {
		git.checkout_prj(PIPELINE_PRIORITY)
            }
            timeout (time: 20, unit: 'MINUTES')
            {
                dir ("amg-hpedu/800_Workspace/IBC_Appl_Tasking/build")
                {
                    unstash "BUILD_RESULT"
                }
            }
            timeout (time: 2, unit: 'MINUTES')
            {
                dir("amg-hpedu/800_Workspace/IBC_A2L")
                {
                    executeASAP2('01_ASAP2Creator.bat JenkinsUsr')
                    executeASAP2('02_ASAP2Merger.bat JenkinsUsr')
                    executeASAP2('03_ASAP2Updater.bat JenkinsUsr')
                }
                // VersionLogger
                dir("amg-hpedu/900_Tools/Scripts/Versionlogger")
                {
                    bat "python tool2versionlog.py asap2_checker"
                    bat "python tool2versionlog.py asap2_comparer"
                    bat "python tool2versionlog.py asap2_creator"
                    bat "python tool2versionlog.py asap2_merger"
                    stash includes: '*_cmd.log, *_toolversion.xml', name: "Asap2_Versionlogger"
                }
            }
            timeout (time: 2, unit: 'MINUTES')
            {
                bat "python amg-hpedu/200_SwLib/bp-infrastructure/Scripts/ASAP2Toolset/asap2toolset2warningsng.py amg-hpedu/800_Workspace/IBC_A2L/Log1_Creator.txt amg-hpedu/800_Workspace/IBC_A2L/Log1_Creator.xml"
                bat "python amg-hpedu/200_SwLib/bp-infrastructure/Scripts/ASAP2Toolset/asap2toolset2warningsng.py amg-hpedu/800_Workspace/IBC_A2L/Log2_Merger.txt amg-hpedu/800_Workspace/IBC_A2L/Log2_Merger.xml"
                bat "python amg-hpedu/200_SwLib/bp-infrastructure/Scripts/ASAP2Toolset/asap2toolset2warningsng.py amg-hpedu/800_Workspace/IBC_A2L/Log3_Updater.txt amg-hpedu/800_Workspace/IBC_A2L/Log3_Updater.xml"
            }
            timeout (time: 2, unit: 'MINUTES')
            {
                dir("amg-hpedu/800_Workspace/IBC_A2L")
                {
                    executeASAP2('04_ASAP2Merger_AMG_RDNA.bat JenkinsUsr')
                    executeASAP2('05_ASAP2Updater_AMG_RDNA.bat JenkinsUsr')
                    executeASAP2('05a_ASAP2Merger.bat JenkinsUsr')
                }
            }
        }
        catch(Exception e)
        {
            echo "Stage ${stage_name} failed with error: ${e}"
            currentBuild.result = 'FAILURE'
            error("[DEBUG][A2L] Generate a2l failed in processA2Lgeneration: ${e}")
            // abort_jenkins_build()
        }
    }
}
// used for nested parallel stages
def TRACE32 = [:]
def POST_BUILD = [:]


// kumbhvsh introduced a variable for failfast
def IT_CANCELLED = false



if (params.TRACE32_OTTTEST || isimportantbranch_or_Release() || isScheduledRC())
{
    TRACE32['Trace32 OTT test'] =
    {
        stage ('Trace32 OTT test')
        {
            
            node('AMG_HPEDU_B1_HW')
            {
                lock(resource: null, quantity: 1,  label: 'AMG_HPEDU_B1_HW', priority: PIPELINE_PRIORITY)
                {
                    // executeTrace32(STAGE_NAME, PIPELINE_PRIORITY)
                    // ===== GUARD (like Declarative "when") =====
                    script {
                        if (currentBuild.result != null && currentBuild.result != 'SUCCESS') {
                        echo "[DEBUG][TRACE][1] Skipping OTT because build already ${currentBuild.result}"

                        // Mark this stage as ABORTED (grey) and do not continue
                        catchError(buildResult: 'FAILURE', stageResult: 'ABORTED') {
                            error("Cancelled due to earlier failure")
                        }
                        return
                        }
                    }
                    try
                    {
                        echo "[DEBUG][TRACE][1] STARTED"
                        executeTrace32(STAGE_NAME, PIPELINE_PRIORITY)
                        echo "[DEBUG][TRACE][1] COMPLETED"
                    }
                    catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                    echo "[DEBUG][CALIB][1] ABORTED (failFast cancel): ${fie}"
                    // catchError(buildResult: 'FAILURE', stageResult: 'ABORTED')
                    // {
                    //     error("[DEBUG][CALIB][1] cancelled")
                    // } -->not yet tried 

                    isParallelStage1Failed=true
                    currentBuild.result='FAILURE'
                    echo "[DEBUG][TRACE][1] executeTrace32 complted because error caught"
                    throw fie

                    } catch (Exception e) {
                    echo "[DEBUG][CALIB][1] FAILED: ${e}"
                    isParallelStage1Failed=true
                    currentBuild.result='FAILURE'
                    throw e
                    }
                    }
            }
        }
    }
}
if (params.TRACE32_CANOETEST || isimportantbranch_or_Release() || isScheduledRC())
{
    TRACE32['Trace32 flash and Canoe test'] =
    {
        stage ('Trace32 flash and Canoe test')
        {
            node('AMG_HPEDU_B1_HW')
            {
                lock(resource: null, quantity: 1,  label: 'AMG_HPEDU_B1_HW', priority: PIPELINE_PRIORITY)
                {
                    // executeCanoeTest(STAGE_NAME, PIPELINE_PRIORITY)
                    // ===== GUARD (like Declarative "when") =====
                    script {
                        if (currentBuild.result != null && currentBuild.result != 'SUCCESS') {
                        echo "[DEBUG][TRACE][2] Skipping Caneo because build already ${currentBuild.result}"

                        // Mark this stage as ABORTED (grey) and do not continue
                        catchError(buildResult: 'FAILURE', stageResult: 'ABORTED') {
                            error("Cancelled due to earlier failure")
                        }
                        return
                        }
                    }

                    try
                    {
                        executeCanoeTest(STAGE_NAME, PIPELINE_PRIORITY)
                    }
                    catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                    echo "[DEBUG][CALIB][2] ABORTED (failFast cancel): ${fie}"
                    // catchError(buildResult: 'FAILURE', stageResult: 'ABORTED')
                    // {
                    //     error("[DEBUG][CALIB][1] cancelled")
                    // } -->not yet tried 
                    echo "[DEBUG][TRACE][2] executeCanoeTest complted because error caught "
                    throw fie

                    } catch (Exception e) {
                    echo "[DEBUG][CALIB][2] FAILED: ${e}"
                    throw e
                    }
                }
            }
        }
    }
}
POST_BUILD['Merge Calibrationfiles'] = { executeMergeCalibrationFiles(PIPELINE_PRIORITY) }
POST_BUILD['SemanticCA Astree'] = { executeSemanticCAAstree(PIPELINE_PRIORITY) }



def executeMergeCalibrationFiles(PIPELINE_PRIORITY)
{
    stage ('Merge Calibrationfiles')
    {
        node('AMG-HPEDU-CALIB')
        {
            lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
            {
                try
                {
                    jenkinsOps.printAgentWSInfo()
                    processcalib(STAGE_NAME, PIPELINE_PRIORITY)
                    processvCDM(STAGE_NAME, PIPELINE_PRIORITY)
                }
                catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                echo "[DEBUG][CALIB][1] ABORTED (failFast cancel): ${fie}"
                // catchError(buildResult: 'FAILURE', stageResult: 'ABORTED')
                // {
                //     error("[DEBUG][CALIB][1] cancelled")
                // } -->not yet tried 
                throw fie

                } catch (Exception e) {
                echo "[DEBUG][CALIB][1] FAILED: ${e}"
                throw e
                }

                
            }
        }
    }
}

def executeSemanticCAAstree(PIPELINE_PRIORITY)
{
    stage ('SemanticCA Astree')
    {
        lock(resource: null, quantity: 1, label: 'AMG-HPEDU-ASTREE', priority: PIPELINE_PRIORITY)
        {
            node('AMG-HPEDU-ASTREE')
            {
                // jenkinsOps.printAgentWSInfo()
                // processSemanticCA(STAGE_NAME, PIPELINE_PRIORITY)
                // postASTREESemanticCA(STAGE_NAME)
                try
                {
                    jenkinsOps.printAgentWSInfo()
                    processSemanticCA(STAGE_NAME, PIPELINE_PRIORITY)
                    postASTREESemanticCA(STAGE_NAME)
                }
                catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                echo "[DEBUG][CALIB][2] ABORTED (failFast cancel): ${fie}"
                // catchError(buildResult: 'FAILURE', stageResult: 'ABORTED')
                // {
                //     error("[DEBUG][CALIB][2] cancelled")
                // }  --> not yet tried 

                throw fie

                } catch (Exception e) {
                echo "[DEBUG][CALIB][2] FAILED: ${e}"
                throw e
                }
            }
        }
    }
}

def executeUTJob(UTJob, PIPELINE_PRIORITY)
{
    // catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE')
    // {
    //     if (env.NODE_NAME == "AMGHPEDU_TC38XXINSTRSIM")
    //     {
    //         BASE_PATH_UT = "E:\\Jenkins_UT\\workspace"
    //     }
    //     else
    //     {
    //         BASE_PATH_UT = "E:\\Jenkins\\workspace"
    //     }

    //     dir("${BASE_PATH_UT}")
    //     {
    //         sleep 10
    //         bat script:
    //         '''
    //             sh -c \"rm -r -d -f -v ut-*\"
    //         '''
    //         sleep 10
    //         dir("ut-${UTJob}")
    //         {
    //             stage("UT ${UTJob}")
    //             {
    //                 processUnittestwithOption("${UTJob}", PIPELINE_PRIORITY)
    //             }
    //         }
    //         sleep 10
    //         bat script:
    //         '''
    //             sh -c \"rm -r -d -f -v ut-*\"
    //         '''
    //         sleep 10
    //     }
    // }
    script{

    stage_name = "UT-XUNIT SIL"
    try
    {
        if (env.NODE_NAME == "AMGHPEDU_TC38XXINSTRSIM")
        {
            BASE_PATH_UT = "E:\\Jenkins_UT\\workspace"
        }
        else
        {
            BASE_PATH_UT = "E:\\Jenkins\\workspace"
        }

        dir("${BASE_PATH_UT}")
        {
            sleep 10
            bat script:
            '''
                sh -c \"rm -r -d -f -v ut-*\"
            '''
            sleep 10
            dir("ut-${UTJob}")
            {
                stage("UT ${UTJob}")
                {
                    processUnittestwithOption("${UTJob}", PIPELINE_PRIORITY)
                }
            }
            sleep 10
            bat script:
            '''
                sh -c \"rm -r -d -f -v ut-*\"
            '''
            sleep 10
        }
    }
    catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
      echo "[DEBUG] Stage: ${stage_name} aborted/cancelled: ${fie}"
      throw fie  // keep cancellation semantics (failFast/abort)

    } catch (Exception e) {
      echo "[DEBUG] Stage: ${stage_name} failed with error: ${e}"
      currentBuild.result = 'FAILURE'
      throw e    // make the stage really fail
    }
    finally
    {
        env.UT_EXECUTED = 'true'
        if(currentBuild.currentResult != 'SUCCESS')
        {
            JOB_STATE = 'Testing_stage_failed'
        }
    }

    
}
}

def processIT(stage_name, PIPELINE_PRIORITY)
{
    jenkinsOps.printAgentWSInfo()
    script
    {
        try
        {
            // error "kumbhvsh:introduced error in processIT"
            jenkinsOps.prepws()
            dir("amg-hpedu-bsw")
            {
                git.checkout_prj(PIPELINE_PRIORITY)
            }
            timeout (time: 40, unit: 'MINUTES')
            {
                testbench.enable_Powersupply_Lauterbach()
                dir ("amg-hpedu-bsw/800_Workspace/TPC_IT_Parasoft")
                {
                    bpinstaller()
                }
                testbench.prepare_SIM_or_HW_for_IT()
                dir ("amg-hpedu-bsw/800_Workspace/TPC_IT_Parasoft/IT_PIL")
                {
                    dir ("make")
                    {
                        bat script:
                        '''
                            python gen.py --TB %TOOLPATH% --NA \"-j 1\"
                        '''
                    }
                    parasoft.runParasoft("start_IT_Framework.bat JenkinsUsr")
                    dir ("ITPRprt")
                    {
                        powershell 'Get-ChildItem -Recurse -Include console.out | ForEach-Object {$(Get-Content $_)} | Out-File -Encoding ASCII console_ASCII.out'
                    }
                }
                dir ("${WORKSPACE}")
                {
                    stash allowEmpty: true, includes: 'Versionlog_TB.txt', name: 'Versionlog_TB'
                }
                bat "python amg-hpedu-bsw/200_SwLib/bp-infrastructure/Scripts/CPPTest/CPP_TEST_ERRORLIST.py amg-hpedu-bsw/800_Workspace/TPC_IT_Parasoft/IT_PIL/ITPRprt/IT_xunit_report.xml amg-hpedu-bsw/800_Workspace/TPC_IT_Parasoft/IT_PIL/ITPRprt/CPPTest_static_IT_Issue.xml"
            }
        }
        catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
            echo "[DEBUG] Stage: ${stage_name} aborted/cancelled: ${fie} from processIT catch fie"
            throw fie                      // IMPORTANT: propagate cancellation
            }
        catch(Exception e)
        {
            echo "[DEBUG] Stage: ${stage_name} failed with error: ${e} from processIT catch e"
            currentBuild.result = 'FAILURE'
            throw e
            // abort_jenkins_build()
        }
    }
}

pipeline
{
    agent none
    environment
    {
        CANOE_PYTHON                    = "E:\\Prg\\python-3.11.8-native-windows-embed-amd64_v1.1.0"
        HEXVIEWTOOLCHAIN                = "E:\\Prg\\Hexview\\V1.15.04"
        VCDM_PATH                       = "E:\\Prg\\Vector\\vCDM_21.1_SP2\\vCDMstudio\\Exec64"
        ASAP2TOOLCHAIN                  = "E:\\Prg\\Vector\\ASAP2Tool-Set_15.0\\Bin"
        BSWBUILDENV                     = "E:\\Prg\\BSW\\BuildEnv\\mingw64\\bin;E:\\Prg\\BSW\\BuildEnv\\usr\\bin"
        BSWBUILDENV_DEV                 = "E:\\Prg\\BSW\\BuildEnv-dev\\mingw64\\bin;E:\\Prg\\BSW\\BuildEnv-dev\\usr\\bin"
        PARASOFT_TOOLCHAIN              = "E:\\Prg\\Parasoft\\2024.1.0\\cpptest"
        TASKING_BASE_PATH               = "E:/Prg/TASKING/TriCore_v6.3r1p9"
        TOOLPATHGCC                     = "E:\\Prg\\gcc\\9.5.0_x64\\mingw64\\bin"
        GCC                             = "${TOOLPATHGCC}"
        TOOLPATH                        = "${TASKING_BASE_PATH}/ctc/bin"
        NODEJS                          = "E:\\Prg\\node-v16.13.2-win-x64"
        WS008190_GIT                    = "E:\\Prg\\Git\\bin"
        ASTREE_BASE                     = "E:/Prg/AbsInt/AdvancedAnalyzer/c/b14842278/bin"
        MSBuild                         = "E:/Prg/Microsoft/Visual_Studio/2017/BuildTools/MSBuild/15.0/Bin"
        HIGHTECH_MCS                    = "E:\\Prg\\HighTec\\toolchains\\mcs\\v3.0\\bin"
        PATH                            = "${HEXVIEWTOOLCHAIN};${NODEJS};${ASAP2TOOLCHAIN};${TOOLPATHGCC};${PARASOFT_TOOLCHAIN};${PARASOFT_TOOLCHAIN}\\bin\\engine\\bin;${TOOLPATH};${BSWBUILDENV};${BSWBUILDENV_DEV};${ASTREE_BASE};${MSBuild};${VCDM_PATH};${HIGHTECH_MCS};C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0"
        TOOL_INSTALLATION_PATH          = "E:/Prg"
        TRACE32                         = "E:\\Prg\\Lauterbach\\T32_2023-02\\bin\\windows64"
        TSK_OPTIONS_FILE_SW160800v6_3r1 = "E:\\Prg\\Tasking\\TriCore_v6.3r1p9\\etc\\licopt.txt"
        UTNM_ROOT                       = "E:/Prg/SEH/SEH_UTN_Manager"
        SZIP                            = "c:\\Program Files\\7-Zip\\7z.exe"
        // Settings for Artifactory
        ARTIFACTORY_ID                  = "artifactory.schaeffler.com"
        PkgVersion                      = "${JOB_BASE_NAME}-${BUILD_NUMBER}"
        RT_BUILD_NAME                   = "amg :: AMG_Development"
        RT_BUILD_NUMBER                 = "${JOB_BASE_NAME}.${SW_VERSION_MAJOR}.${SW_VERSION_MINOR}.${BUILD_NUMBER}".replaceAll("[^A-Za-z0-9]", "-")
        RLM_LICENSE                     = "hightec-lic-srv@5053"
        JENKINSUSER                     = "JenkinsUsr"
        DESTINATION_BRANCH              = "${env.CHANGE_TARGET}"
        TRIGGER_INT_TEST                = "${params.TRIGGER_INT_TEST}"
        EMAIL_USER_LIST                 = "laemmdvi@schaeffler.com, ubharpan@schaeffler.com, pardenle@schaeffler.com, schmiptc@schaeffler.com, wolfgang.schirmer@schaeffler.com, genzeaex@schaeffler.com"
        MIRROR_DIR                      = "e:/git-mirrors_for_Jenkins/mainrepo.git"
        MIRROR_DIR_MCAL                 = "e:/git-mirrors_for_Jenkins/MCALrepo.git"
        MIRROR_DIR_SafeTpack            = "e:/git-mirrors_for_Jenkins/SafeTpackrepo.git"
        MIRROR_DIR_Parasoft             = "e:/git-mirrors_for_Jenkins/Parasoftrepo.git"
        MIRROR_DIR_RDNA                 = "e:/git-mirrors_for_Jenkins/RDNArepo.git"
        MIRROR_DIR_amg_hpedu_altium_tasking = "e:/git-mirrors_for_Jenkins/amg-hpedu-altium-taskingrepo.git"
        MIRROR_DIR_bp_infrastructure = "e:/git-mirrors_for_Jenkins/bp-infrastructurerepo.git"
        REPO_URL   = "https://github.vitesco.io/GHE-Schaeffler-Group/amg-hpedu-bsw.git"
        TRIGGER_UNIT_TEST               = "${params.TRIGGER_UNIT_TEST}"
    }
    options
    {
        // Do not checkout automatically at each stage entry
        skipDefaultCheckout()
        // Do not run multiple builds in parallel
        disableConcurrentBuilds ()
        // Do not resume on controller restart
        disableResume ()
        // Only keep some builds' artifacts and output
        buildDiscarder(logRotator(artifactNumToKeepStr: '20', numToKeepStr: '20'))
        // handle color of matlab warnings and errors
        ansiColor('xterm')
        // prepend timestamps on the console output
        timestamps()

        // parallelsAlwaysFailFast()
    }
    parameters
    {
         booleanParam(name: 'CLEAN_WS',             defaultValue: false,    description: 'With this Parameter is it possible to clean the workspace on development branches')
         booleanParam(name: 'RELEASECANDIDATE',     defaultValue: false,    description: 'Please set this value to \"true\" if you should create a release candidate at the Sprint End')
         booleanParam(name: 'TRACE32_OTTTEST',      defaultValue: false,    description: 'activate the OTT(Faultinjection) test')
         booleanParam(name: 'TRACE32_CANOETEST',    defaultValue: false,    description: 'activate a small flash test')
         booleanParam(name: 'TRIGGER_INT_TEST',     defaultValue: false,    description: 'Trigger Integration Test Stage')
         booleanParam(name: 'TRIGGER_UNIT_TEST',    defaultValue: false,    description: 'Trigger Unit Test Stage')
         string(name:       'SW_VERSION_MAJOR',     defaultValue: '',       description: 'It is only important, if you create a RC. Set the SW Major Version in this format: 24, nothing else')
         string(name:       'SW_VERSION_MINOR',     defaultValue: '',       description: 'It is only important, if you create a RC. Set the SW Minor Version in this format: 00, nothing else')
         string(name:       'CHECKOUTPOINT',        defaultValue: '',       description: 'It is only important, if you create a RC. Which checkoutpoint is for the Release?.(example: branch: */TASK-0815_PREPREL or commit id: a130030)')
         string(name:       'SPRINTID',             defaultValue: '',       description: 'For which SPRINT is the RC?(looks here: <a href="https://atmsw-database.schaeffler.com:8443/cb/category/335588">AMG SPRINT</a>)')
         string(name:       'RELEASEID',            defaultValue: '',       description: 'For which Release is the RC?(looks here: <a href="https://atmsw-database.schaeffler.com:8443/cb/category/334958">AMG RELEASE</a>)')
    }
    stages
    {
        stage ('preparation for RC creation')
        {
            agent
            {
                label 'AMG-HPEDU-GENERIC'
            }
            when
            {
                beforeAgent true
                beforeOptions true
                anyOf{
                    expression { isScheduledRC() }
                    environment name: 'RELEASECANDIDATE', value: "true"
                }
            }
            options
            {
                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
            }
            steps
            {
                script{
                    if(isScheduledRC())
                    {
                        fetchCurrentRC(PIPELINE_PRIORITY)
                    }
                }
                handleRcParams()
                checkParameter()
                processgittagRC(PIPELINE_PRIORITY)
                processSwName(PIPELINE_PRIORITY)
            }
            post
            {
                always
                {
                    cleanWs deleteDirs: true, disableDeferredWipeout: true, notFailBuild: true
                }
            }
        }
        stage ('Prep References')
        {
            agent
            {
                label 'AMG-HPEDU-GENERIC'
            }
            options
            {
                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
            }
            steps
            {
                discoverReferenceBuild referenceJob: 'Mechatronics_Platform/AMG-HPEDU/amg-hpedu-build/main'
            }
        }
        stage('Detect changes in UT') {
            agent
            {
                label 'AMG-HPEDU-GENERIC'
            }
            options
            {
                lock(resource: null, quantity: 1, label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
            }
            when
            {
                beforeAgent true
                beforeOptions true
                allOf
                {
                    expression { return !(params.RELEASECANDIDATE) && !isScheduledRC() }
                    expression { return !(env.BRANCH_NAME =~ 'main*|MNT_REL-*') }
                }
            }
            steps {
                script {
                    jenkinsOps.printAgentWSInfo()
                    ONLY_RUN_UT = jenkinsOps.onlyRunUnitTestStage(PIPELINE_PRIORITY)
                    echo "ONLY_RUN_UT (Skip Parallel Stage 1): ${ONLY_RUN_UT}"
                    if( isPR() ) {
                        env.ATTINY_CHANGED = getChangedATTinyFiles()
                    }
                    checkTestVectorFormat()
                }
            }
        }
        stage ('Parallel Stage 1')
        {
            when
            {
                beforeAgent true
                beforeOptions true
                expression { ONLY_RUN_UT == false }
            }
            failFast true
            parallel
            {
                stage ('GIT HASH and SDD')
                {
                    stages
                    {
                        stage ('GIT HASH')
                        {
                            agent
                            {
                                label 'AMG-HPEDU-GENERIC'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            steps
                            {
                                determinateCommitHASH(PIPELINE_PRIORITY)
                            }
                        }
                        stage('SDD code validation')
                        {
                            agent
                            {
                                label 'AMG-HPEDU-GENERIC'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            steps
                            {
                                processSDDCODEVALIDATION(PIPELINE_PRIORITY)
                            }
                            post
                            {
                                always
                                {
                                    postSDDCODEVALIDATION()
                                }
                            }
                        }
                    }
                }
            //     stage ('ASTREE')
            //     {
            //         agent
            //         {
            //             label 'AMG-HPEDU-ASTREE'
            //         }
            //         options
            //         {
            //             lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-ASTREE', priority: PIPELINE_PRIORITY)
            //         }
            //         steps
            //         {
		    //  script
		    //  {
            //             astree.processSCA(PIPELINE_PRIORITY)
            //             astree.processSCA_ATTiny(PIPELINE_PRIORITY)
		    //  }
            //         }
            //         post
            //         {
            //             always
            //             {
            //                 echo "Stage 'ASTREE' completed."
            //             }
            //         }
            //     }
                stage('Build ATTiny')
                {
                    agent
                    {
                        label 'AMG-HPEDU-BUILD-ATTINY'
                    }
                    when
                    {
                        beforeAgent true
                        beforeOptions true
                        expression { env.ATTINY_CHANGED == 'true' }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        processATTiny(PIPELINE_PRIORITY)
                    }
                }
                stage('Unittest ATTiny')
                {
                    agent
                    {
                        label 'AMG-HPEDU-UT-ATTINY'
                    }
                    when
                    {
                        beforeAgent true
                        beforeOptions true
                        expression { env.ATTINY_CHANGED == 'true' }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        processUT_ATTiny(PIPELINE_PRIORITY)
                    }
                }
                stage ('MemMap Check')
                {
                    agent
                    {
                        node
                        {
                            label 'AMG-HPEDU-MEMMAP'
                        }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        script
                        {
                            memmap.gen(PIPELINE_PRIORITY)
                        }
                    }
                }
                stage ('Tresos Generation')
                {
                    agent
                    {
                        node
                        {
                            label 'AMG-HPEDU-TRESOS'
                        }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        script {
                            tresos.processGeneration(PIPELINE_PRIORITY)
                        }

                    }
                    post
                    {
                        always
                        {
                            script {
                                tresos.postGeneration()
                                tresos.postGenerationCheckFile()
                                tresos.postCheckFile()
                                jenkinsOps.prepws()
                            }
                        }
                    }
                }
                stage ('Check code format')
                {
                    agent
                    {
                        node
                        {
                            label 'AMG-HPEDU-CLANG'
                            customWorkspace "E:\\Jenkins\\workspace\\clang_${JOB_BASE_NAME}"
                        }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        script
                        {
                            clangFormat.process(PIPELINE_PRIORITY)
                        }
                    }
                    post
                    {
                        always
                        {
                            recordIssues (enabledForFailure: true, skipBlames: true,
                                qualityGates: [
                                    [threshold: 1, type: 'TOTAL_NORMAL', unstable: false],
                                    [threshold: 1, type: 'NEW_NORMAL', unstable: false],
                                    [threshold: 1, type: 'TOTAL_HIGH', unstable: false],
                                    [threshold: 1, type: 'NEW_HIGH', unstable: false],
                                    [threshold: 1, type: 'TOTAL_ERROR', unstable: false],
                                    [threshold: 1, type: 'NEW_ERROR', unstable: false]
                                ], tools: [clang(name: 'Clang Formater', id: "CLANGFORMAT", pattern: "**/format.warn")],
                                sourceDirectories: [[path: 'amg-hpedu/100_SwAppl']])
                            script {
                                jenkinsOps.prepws()
                            }
                        }
                    }
                }
//                stage ('Host build VS')
//                {
//                    agent
//                    {
//                        label 'AMG-HPEDU-VISUALSTUDIO'
//                    }
//                    options
//                    {
//                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-VISUALSTUDIO', priority: PIPELINE_PRIORITY)
//                    }
//                    steps
//                    {
//                        processHostBuildVS(PIPELINE_PRIORITY)
//                    }
//                    post
//                    {
//                        always
//                        {
//                            postHostBuildVS()
//                        }
//                    }
//                }
                stage ('Intg Test: Customer build')
                {
                    agent
                    {
                        label 'AMG-HPEDU-TASKING'
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-TASKING', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        customerbuild(PIPELINE_PRIORITY)
                    }
                }
//               stage('Gliwa Target')
//               {
//                   stages
//                   {
//                       stage ('Build GLiwa libs')
//                       {
//                           agent
//                           {
//                               label 'AMG-HPEDU-TASKING'
//                           }
//                           options
//                           {
//                               lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-TASKING', priority: PIPELINE_PRIORITY)
//                           }
//                           steps
//                           {
//                               script
//                               {
//                                   try
//                                   {
//                                       processBuildGLiwaLib(STAGE_NAME, PIPELINE_PRIORITY)
//                                   }
//                                   catch (Exception e)
//                                   {
//                                       throw e
//                                   }
//                               }
//                           }
//                           post
//                           {
//                               always
//                               {
//                                   postBuildGLiwaLib(STAGE_NAME)
//                               }
//                           }
//                       }
//                   }
//               }
                stage('main Target')
                {
                    stages
                    {
                        stage ('Build libs')
                        {
                            agent
                            {
                                label 'AMG-HPEDU-TASKING'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-TASKING', priority: PIPELINE_PRIORITY)
                            }
                            steps
                            {
                                script {
                                jenkinsOps.printAgentWSInfo()
                                try {
                                    processBuildLib(STAGE_NAME, PIPELINE_PRIORITY)
                                } catch (e) {
                                    isParallelStage1Failed = true
                                    currentBuild.result = 'FAILURE'
                                    error("Build libs failed: ${e}")
                                }
                                }
                            }
                            post
                            {
                                always
                                {
                                    // script
                                    // {
                                    //     if(currentBuild.currentResult != 'SUCCESS')
                                    // {
                                    //     echo "[DEBUG] currentresult - ${currentBuild.currentResult}"
                                    //     isParallelStage1Failed=true
                                    //     currentBuild.currentResult = 'FAILURE'
                                    // }
                                    // }
                                    echo "[DEBUG][BUILD] currentresult - ${currentBuild.currentResult}"
                                    echo "[DEBUG][BUILD] result - ${currentBuild.result}"
                                    postBuildLib(STAGE_NAME)
                                }
                            }
                        }
                        stage ('Generate A2L')
                        {
                            when{
                                expression { currentBuild.currentResult == 'SUCCESS' }    //added by kumbhvsh
                            }
                            
                            agent
                            {
                                label 'AMG-HPEDU-A2L'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            steps
                            {
                                
                                script {
                                
                                try {
                                    processA2Lgeneration(STAGE_NAME, PIPELINE_PRIORITY)
                                } catch (e) {
                                    isParallelStage1Failed = true
                                    currentBuild.result = 'FAILURE'
                                    error("[DEBUG][A2L] Generate a2l failed: ${e}")
                                }
                                }
                            }
                            post
                            {
                                always
                                {
                                    postGenerateA2L(STAGE_NAME)
                                }
                            }
                        }
                        stage ('Merge Calib and Semantic CA')
                        {
                            when{
                                expression { currentBuild.currentResult == 'SUCCESS' } 
                            }
                              //added by kumbhvsh
                            steps
                            {
                                script
                                {   echo "Stage '${STAGE_NAME}' completed. Current build result: ${currentBuild.result}"


                                     try {
                                        parallel([failFast: true] + POST_BUILD)
                                     }
                                     catch (e) {
                                        isParallelStage1Failed = true
                                        currentBuild.result = 'FAILURE'
                                        error("Merge calib failed: ${e}")
                                    } 
                                    // catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                                    //     // Interruption from timeout/abort/failFast cancellation
                                    //     echo "Caught FlowInterruptedException (will force FAILURE): ${fie}"
                                    //     currentBuild.result = 'FAILURE'
                                    //     error("Converted interruption to FAILURE") // throws a non-interruption error -> final result = FAILURE
                                    // } catch (InterruptedException ie) {
                                    //     // Some steps (like SCM) can throw plain InterruptedException
                                    //     echo "Caught InterruptedException (will force FAILURE): ${ie}"
                                    //     currentBuild.result = 'FAILURE'
                                    //     error("Converted InterruptedException to FAILURE")
                                    // } catch (Exception e) {
                                    //     echo "Caught Exception: ${e}"
                                    //     isParallelStage1Failed=true
                                    //     currentBuild.result = 'FAILURE'
                                    //     throw e // Normal exception -> final result = FAILURE
                                    // }  --> it is working 





                                    // try {
                                    //     parallel([failFast: true] + POST_BUILD)
                                    // } catch (Exception e) {
                                    //     // If the fail-fast canceled siblings, force a FAILURE result for the job
                                    //     // def isFailFast = (e.causes?.toString() ?: '').contains('ParallelStep$FailFastCause')
                                    //     echo "Inside try catch in Merge Calib"
                                    //     def isFailFast = e.toString().contains('ParallelStep$FailFastCause')
                                    //     echo "isFailFast - ${isFailFast}"
                                    //     // if (isFailFast) {
                                    //     //     echo "Inside catch result is ${currentBuild.result}"
                                    //     currentBuild.result = 'FAILURE'
                                    //     throw e
                                    //     echo "After error throw result is ${currentBuild.result}"
                                    // }

                                        // Actual scripted parallel with failfast
                                        // parallel([failFast: true] + POST_BUILD)


                                    // parallel POST_BUILD+[failFast: true]


                                    // try{
                                    //     parallel POST_BUILD+[failFast: true]
                                    // }
                                    // catch (Exception e)
                                    // {
                                    //     echo "ERROR: ${e}"
                                    //     currentBuild.result = 'FAILURE'
                                    //     // abort_jenkins_build()
                                    // }
                                }
                            }
                        }
                        stage ('Trace32 OTT and Canoe Test')
                        {
                            when
                            {
                                beforeAgent true
                                beforeOptions true
                                anyOf{
                                    environment name: 'TRACE32_OTTTEST', value: 'true'
                                    environment name: 'TRACE32_CANOETEST', value: 'true'
                                    expression { isimportantbranch() }
                                }
                            }
                            steps
                            {
                                script
                                {
                                    echo "[DEBUG][TRACE]Inside trace32 result is ${currentBuild.result}"
                                    // try {
                                    //     parallel([failFast: true] + TRACE32)
                                    // } catch (Exception e) {
                                    //     // If the fail-fast canceled siblings, force a FAILURE result for the job
                                    //     def isFailFast = e.toString().contains('ParallelStep$FailFastCause')
                                    //     if (isFailFast) { currentBuild.result = 'FAILURE' }
                                    //     throw e
                                    // }

                                    try {
                                        parallel([failFast: true] + TRACE32)
                                        // parallel TRACE32
                                     }
                                     catch (e) {
                                        isParallelStage1Failed = true
                                        currentBuild.result = 'FAILURE'
                                        error("[DEBUG][TRACE] Trace32 failed: ${e}")
                                    } 





                                    // parallel TRACE32+[failFast: true]
                                    // parallel([failFast: true] + TRACE32)
                                    // try{
                                    //     parallel TRACE32
                                    // }
                                    // catch (Exception e)
                                    // {
                                    //     echo "ERROR: ${e}"
                                    //     currentBuild.result = 'FAILURE'
                                    //     // abort_jenkins_build()
                                    // }

                                    // catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                                    //     // Actual scripted parallel with failfast
                                    //     parallel([failFast: true] + TRACE32)

                                    // }

                                }
                            }
                        }
                    }
                }
                stage ('mcs build')
                {
                    agent
                    {
                        label 'AMG-HPEDU-MCS-BUILD'
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                    }
                    steps
                    {
                        script
                        {
                            mcs.build(PIPELINE_PRIORITY)
                            mcs.postBuildCheck(PIPELINE_PRIORITY)
                        }
                    }
                }
                // stage('UT-XUNIT PIL')
                // {
                //     agent
                //     {
                //         label 'TC38XX'
                //     }
                //     when
                //     {
                //         beforeAgent true
                //         beforeOptions true
                //         allOf
                //         {
                //             expression { return !params.RELEASECANDIDATE }
                //             expression { isPR() }
                //         }
                //     }
                //     options
                //     {
                //         lock(resource: null, quantity: 1,  label: 'TC38XX', priority: PIPELINE_PRIORITY)
                //     }
                //     steps
                //     {
                //         executeUTJob("XUNIT", PIPELINE_PRIORITY)
                //     }
                // }




                stage('UT-XUNIT SIL')
                {
                    agent
                    {
                        label 'TC38XXINSTRSIM'
                    }
                    when
                    {
                        beforeAgent true
                        beforeOptions true
                        // expression { currentBuild.currentResult == 'SUCCESS' }
                        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
                        allOf
                        {
                            expression { return (!params.RELEASECANDIDATE || !isScheduledRC()) }
                            anyOf
                            {
                                expression { ismainorMNT() }
                                expression { params.TRIGGER_UNIT_TEST }
                                expression { isPR() }
                            }
                        }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'TC38XXINSTRSIM', priority: PIPELINE_PRIORITY)
                    }
                    steps {
                        script {
                            try {
                                echo "[DEBUG][SIL] STARTED"
                                error "kumbhvsh: in sil"
                                // executeUTJob("XUNIT", PIPELINE_PRIORITY)
                                echo "[DEBUG][SIL] COMPLETED"

                            } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                                echo "[DEBUG][SIL] ABORTED (cancelled by failFast/abort): ${fie}"
                                isParallelStage1Failed=true
                                currentBuild.result='FAILURE'
                                throw fie
                                // swallow only cancellation
                            } catch (Exception e) {
                                echo "[DEBUG][SIL] FAILED (real error): ${e}"
                                isParallelStage1Failed=true
                                currentBuild.result='FAILURE'
                                throw e   // keep FAILURE for real SIL problems
                            }
                            }
                        // script {
                        //     // try {
                        //     // echo "Present in sil"
                        //     // // executeUTJob("XUNIT", PIPELINE_PRIORITY)
                        //     // } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                        //     // echo "UT-XUNIT SIL was cancelled (failFast/parallel cancellation): ${fie}"
                        //     // // do not rethrow
                        //     // }


                        //     echo "[DEBUG][SIL] STARTED "
                        //     executeUTJob("XUNIT", PIPELINE_PRIORITY)
                        //     echo "[DEBUG][SIL] COMPLETED "

                        //     // try {
                        //     //     echo "Inside sil"
                        //     //     // executeUTJob("XUNIT", PIPELINE_PRIORITY)
                        //     // } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                        //     //     echo "UT-XUNIT SIL cancelled by failFast: ${fie}"
                        //     //     // do not rethrow
                        //     // }
                        // }
                        }
                    // steps
                    // {   echo "Present in sil"

                    //     // executeUTJob("XUNIT", PIPELINE_PRIORITY)
                    // }
                }




                stage('Integration Test')
                {
                    agent
                    {
                        node
                        {
                            label 'TC38XXINSTRSIM'
                        }
                    }
                    when
                    {
                        beforeAgent true
                        beforeOptions true
                        // expression { currentBuild.currentResult == 'SUCCESS' }

                        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
                        allOf
                        {
                            anyOf
                            {
                                expression { return isimportantbranch() }
                                environment name: 'TRIGGER_INT_TEST', value: 'true'
                            }
                            expression { return !params.RELEASECANDIDATE || !isScheduledRC() }
                        }
                    }
                    options
                    {
                        lock(resource: null, quantity: 1,  label: 'TC38XXINSTRSIM', priority: PIPELINE_PRIORITY)
                    }
                    steps {
                        script {
                            // try {
                            // // processIT(STAGE_NAME, PIPELINE_PRIORITY)
                            // } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                            // echo "Integration cancelled by failFast: ${fie}"
                            // return
                            // }

                            try {
                                echo "[DEBUG][INTE] STARTED"
                                processIT(STAGE_NAME, PIPELINE_PRIORITY)
                                if(currentBuild.currentResult != 'SUCCESS')
                                {
                                    JOB_STATE = "Testing_stage_failed"
                                }
                                echo "[DEBUG][INTE] COMPLETED"

                            } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                                echo "[DEBUG][INTE] ABORTED (cancelled by failFast/abort): ${fie}"
                                isParallelStage1Failed=true
                                currentBuild.result='FAILURE'
                                throw fie
                                // swallow only cancellation
                                // catchError(buildResult: 'FAILURE', stageResult: 'ABORTED') {
                                //     error("[DEBUG][INTE]Integration cancelled by failFast from catch")
                                // }
                            } catch (Exception e) {
                                echo "[DEBUG][INTE] FAILED (real error): ${e}"
                                isParallelStage1Failed=true
                                currentBuild.result='FAILURE'
                                throw e   // keep FAILURE for real SIL problems
                            }
                         }
                        }
                    // steps {
                    //     script {
                    //         try {
                    //         catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    //             processIT(STAGE_NAME, PIPELINE_PRIORITY)

                    //             if (currentBuild.currentResult != 'SUCCESS') {
                    //             JOB_STATE = "Testing_stage_failed"
                    //             }
                    //         }
                    //         } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException fie) {
                    //         // This happens when the branch is cancelled due to failFast in another branch
                    //         echo "Integration Test was cancelled (failFast/parallel cancellation): ${fie}"

                    //         // Do NOT rethrow => avoids overall build becoming ABORTED due to this branch.
                    //         // Leave overall result to the real failing branch (e.g., Merge Calibrationfiles).
                    //         }
                    //     }
                    //     }
                    // steps
                    // {
                    //     catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE')
                    //     {
                    //         // processIT(STAGE_NAME, PIPELINE_PRIORITY)
                    //         script
                    //         {
                    //             if(currentBuild.currentResult != 'SUCCESS')
                    //             {
                    //                 JOB_STATE = "Testing_stage_failed"
                    //             }
                    //         }
                    //     }
                    // }

                    post {
                        always {
                            script {
                            def reports = findFiles(glob: '**/IT_xunit_report.xml')
                            if (reports.size() == 0) {
                                echo "No IT_xunit_report.xml found (likely cancelled by failFast). Skipping postIT."
                            } else {
                                postIT(STAGE_NAME, PIPELINE_PRIORITY)
                            }
                            }
                        }
                        }
                    // post
                    // {
                    //     always
                    //     {
                    //         catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE')
                    //         {
                    //             postIT(STAGE_NAME, PIPELINE_PRIORITY)
                    //         }
                    //     }
                    // }
                }


                
            }
            post {
                always {
                    script {
                    if (isParallelStage1Failed) {
                        echo "[OUTSIDE PARALLEL STAGE 1]"
                        echo "Parallel Stage 1 had failures; forcing build FAILURE (even if ABORTED due to failFast cancellation)."
                        currentBuild.rawBuild.result = hudson.model.Result.FAILURE
                        // currentBuild.currentResult='FAILURE'  -->not works
                        // error("one or more stage(s) in Parallel Stage 1 failed")
                    }
                    }
                }
                success
                {
                    script
                    {
                        if (params.RELEASECANDIDATE)
                        {
                            emailext(
                                to: "${EMAIL_USER_LIST}",
                                subject: "RC Build Successful: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                body: "Parallel Stage 1 Successful - Please check the details at ${env.BUILD_URL}"
                            )
                        }
                        JOB_STATE = "Build_only"
                    }
                }
                failure
                {
                    script
                    {
                        if (params.RELEASECANDIDATE)
                        {
                            emailext(
                                to: "${EMAIL_USER_LIST}",
                                subject: "RC Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                body: "The Parallel Stage 1 has failed. Please check the details at ${env.BUILD_URL}"
                            )
                        }
                    }
                }
            }
        }
        stage ('Package build')
        {
            parallel
            {
                stage('Package')
                {
                    stages
                    {
                        /* In this stage all version log files are collected and merged. */
                        stage('collect all Versionlog Infos')
                        {
                            agent
                            {
                                label 'AMG-HPEDU-PACKAGE'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            when
                            {
                                beforeAgent true
                                beforeOptions true
                                anyOf{
                                    expression { return isScheduledRC() }
                                    environment name: 'RELEASECANDIDATE', value: 'true'
                                }
                            }
                            steps
                            {
                                collectallVersionlogartefacts(PIPELINE_PRIORITY)
                            }
                        }
                        stage('Create AMG_Development package')
                        {
                            agent
                            {
                                label 'AMG-HPEDU-PACKAGE'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            environment
                            {
                                GIT_HASH = "${CommitHash}"
                            }
                            when
                            {
                                beforeAgent true
                                beforeOptions true
                                anyOf{
                                    expression { return isScheduledRC() }
                                    environment name: 'RELEASECANDIDATE', value: 'true'
                                }
                            }
                            steps
                            {
                                processpackagecreation(JOB_STATE, PIPELINE_PRIORITY)
                            }
                        }
                        stage( 'Artifactory Stage 1' )
                        {
                            agent
                            {
                                label 'AMG-HPEDU-PACKAGE'
                            }
                            options
                            {
                                lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
                            }
                            when
                            {
                                beforeAgent true
                                beforeOptions true
                                anyOf{
                                    expression { return isScheduledRC() }
                                    environment name: 'RELEASECANDIDATE', value: 'true'
                                }
                            }
                            steps
                            {
                                script {
                                    jenkinsOps.printAgentWSInfo()
                                    artifactory.process()
                                }

                            }
                        }
                    }
                }
            }
        }
        // stage ('Parallel Stage 2')
        // {
        //     parallel
        //     {
        //         stage('Unit Test')
        //         {
        //             when {
        //                 beforeAgent true
        //                 beforeOptions true
        //                 anyOf {
        //                     expression { return params.RELEASECANDIDATE }
        //                     expression { return ONLY_RUN_UT == true  }
        //                 }
        //             }
        //             steps
        //             {
        //                 script
        //                 {
        //                     parallel UTjobs
        //                     env.UT_EXECUTED = 'true'
        //                 }
        //             }
        //         }
        //         stage( 'Integration Test SIL')
        //         {
        //             agent
        //             {
        //                 node
        //                 {
        //                     label 'TC38XXINSTRSIM'
        //                 }
        //             }
        //             when
        //             {
        //                 beforeAgent true
        //                 beforeOptions true
        //                 expression { return params.RELEASECANDIDATE }
        //             }
        //             options
        //             {
        //                 lock(resource: null, quantity: 1,  label: 'TC38XXINSTRSIM', priority: PIPELINE_PRIORITY)
        //             }
        //             steps
        //             {
        //                 catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE')
        //                 {
        //                     processIT(STAGE_NAME, PIPELINE_PRIORITY)
        //                     script
        //                     {
        //                         if(currentBuild.currentResult != 'SUCCESS')
        //                         {
        //                             JOB_STATE = "Testing_stage_failed"
        //                         }
        //                     }
        //                 }
        //             }
        //             post
        //             {
        //                 always
        //                 {
        //                     catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE')
        //                     {
        //                         postIT(STAGE_NAME, PIPELINE_PRIORITY)
        //                     }
        //                 }
        //             }
        //         }
        //         stage ('Trace32 OTT and Canoe Test')
        //         {
        //             when
        //             {
        //                 beforeAgent true
        //                 beforeOptions true
        //                 expression { params.RELEASECANDIDATE }
        //             }
        //             steps
        //             {
        //                 script
        //                 {
        //                     parallel TRACE32
        //                 }
        //             }
        //         }
        //     }
        // }
        // stage('collect all Versionlog Infos Stage 2')
        // {
        //     agent
        //     {
        //         label 'AMG-HPEDU-GENERIC'
        //     }
        //     options
        //     {
        //         lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
        //     }
        //     steps
        //     {
        //         script
        //         {
        //             if (!params.RELEASECANDIDATE)
        //             {
        //                 collectallVersionlogartefacts(PIPELINE_PRIORITY)
        //             }
        //             if (JOB_STATE != "Testing_stage_failed")
        //             {
        //                 JOB_STATE = "Complete"
        //             }
        //             collectallVersionlogartefacts_UT(PIPELINE_PRIORITY)
        //         }
        //     }
        // }
        // stage('Create AMG_Development package Stage 2')
        // {
        //     agent
        //     {
        //         label 'AMG-HPEDU-GENERIC'
        //     }
        //     environment
        //     {
        //         GIT_HASH = "${CommitHash}"
        //     }
        //     options
        //     {
        //         lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
        //     }
        //     steps
        //     {
        //         script
        //         {
        //             if (!params.RELEASECANDIDATE && ONLY_RUN_UT == false)
        //             {
        //                 processpackagecreation(JOB_STATE, PIPELINE_PRIORITY)
        //                 if(env.ATTINY_CHANGED == 'true')
        //                 {
        //                     def ATTINY_VERSION = getATTinyVersion()
        //                     processAttinyPackage(JOB_STATE, ATTINY_VERSION)
        //                 }
        //             }
        //         }
        //         processpackagecreation_UT(JOB_STATE, PIPELINE_PRIORITY)
        //     }
        // }
        // stage( 'Artifactory Stage 2' )
        // {
        //     agent
        //     {
        //         label 'AMG-HPEDU-GENERIC'
        //     }
        //     options
        //     {
        //         lock(resource: null, quantity: 1,  label: 'AMG-HPEDU-GENERIC', priority: PIPELINE_PRIORITY)
        //     }
        //     steps
        //     {
        //         script {
        //             jenkinsOps.printAgentWSInfo()
        //             artifactory.processUT(ONLY_RUN_UT)
        //             artifactory.setProperty(JOB_STATE)
        //         }
        //     }
        // }
    }
    post
    {
        always {
            script {
            if (isParallelStage1Failed) 
            {
                echo "[OUTSIDE PIPELINE]Forcing FAILURE in pipeline post (no rawBuild)."

                // if Jenkins currently thinks ABORTED, overwrite with FAILURE
                if (currentBuild.currentResult == 'ABORTED') {
                currentBuild.result = 'FAILURE'
                } else {
                currentBuild.result = 'FAILURE'
                }
            }
            }
        }
        unsuccessful
        {
            script
            {
                if (! ((env.BRANCH_NAME =~ 'main*|MNT_REL-*' ) || params.RELEASECANDIDATE))
                {
                    emailext body: '$DEFAULT_CONTENT', recipientProviders: [[$class: 'DevelopersRecipientProvider']], subject: '$DEFAULT_SUBJECT'
                }
                else
                {
                    emailext body: "The Release Candidate has failed. Please check the details at ${env.BUILD_URL}",
                             subject: "Build Failed: Release Candidate ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                             to: "${EMAIL_USER_LIST}"
                }
            }
        }
        success
        {
            script
            {
                if (params.RELEASECANDIDATE)
                {
                    emailext body: '''The Release Candidate ran successful. Please check the details. Link to:

                    Github: https://github.vitesco.io/GHE-Schaeffler-Group/amg-hpedu-bsw/tree/DEV_SPR-${SPRINTID}_RC-${SW_VERSION_MAJOR}.${SW_VERSION_MINOR}.${BUILD_NUMBER}_B
                    Jenkins: ${BUILD_URL}
                                    ''',
                                     subject: "Build Successful: Release Candidate ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                                     to: "${EMAIL_USER_LIST}"
                }
                else
                {
                    emailext body: '$DEFAULT_CONTENT', recipientProviders: [[$class: 'DevelopersRecipientProvider']], subject: '$DEFAULT_SUBJECT'
                }
            }
        }
    }
}
